<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CloudyPop – Breathing Game</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000" id="themeColorMeta">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --bg: #000000;
      --bg-card: rgba(0, 0, 0, 0.7);
      --text-main: #f8f9fa;
      --text-muted: #adb5bd;
      --accent: #6c5ce7;
      --accent-soft: rgba(108, 92, 231, 0.35);
      --shadow: rgba(0, 0, 0, 0.9);
      --background-image: url('https://filebrowser-bg080ow8g44scwgksgks84k0.iconic25snaps.org/files/test/media/atl.png');
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: var(--bg) center/cover fixed no-repeat;
      background-image: var(--background-image);
      opacity: 0.35;
      z-index: 0;
    }

    .cloud-layer {
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 1;
      pointer-events: none;
      background: radial-gradient(circle at top, rgba(0,0,0,0.5) 0, rgba(0,0,0,0.8) 55%);
    }

    .cloud {
      position: absolute;
      width: 220px;
      height: 110px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffffee, #ffffff66, #ffffff11);
      filter: blur(3px);
      opacity: 0.5;
      box-shadow: -40px 10px 60px #ffffff33, 40px -5px 80px #ffffff22;
      animation-name: floatCloud;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    @keyframes floatCloud {
      from { transform: translateX(-30vw) translateY(var(--startY, 0)); }
      to { transform: translateX(130vw) translateY(var(--endY, 0)); }
    }

    .game-wrapper {
      position: relative;
      z-index: 5;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .game-card {
      background: var(--bg-card);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 2rem 2.5rem;
      max-width: 560px;
      width: 100%;
      box-shadow: 0 0 40px var(--shadow);
      backdrop-filter: blur(12px);
    }

    .game-title { font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; font-size: 0.85rem; color: var(--text-muted); }
    .game-logo { font-size: 1.8rem; font-weight: 800; letter-spacing: 0.12em; text-transform: uppercase; }
    .badge-soft { background: var(--accent-soft); color: #fff; border-radius: 999px; padding: 0.2rem 0.7rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; }

    .main-display { margin-top: 1.5rem; margin-bottom: 1.5rem; text-align: center; }
    .phase-label { font-size: 1rem; letter-spacing: 0.16em; text-transform: uppercase; color: var(--text-muted); }
    .phase-label span { display: inline-block; padding: 0.2rem 0.7rem; border-radius: 999px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
    .timer-value { font-size: 9rem; font-weight: 800; line-height: 1; margin-top: 0.2rem; }
    .status-text { font-size: 0.95rem; color: var(--text-muted); margin-top: 0.35rem; min-height: 1.4em; }
    .cycle-counter { font-size: 0.85rem; color: var(--text-muted); }

    .top-right-controls, .bottom-right-controls { position: fixed; z-index: 20; right: 1rem; display: flex; gap: 0.5rem; align-items: center; }
    .top-right-controls { top: 1rem; }
    .bottom-right-controls { bottom: 1rem; flex-wrap: wrap; justify-content: flex-end; }

    .icon-btn { border-radius: 999px; border-width: 1px; padding: 0.55rem 0.75rem; display: inline-flex; align-items: center; justify-content: center; gap: 0.25rem; font-size: 1rem; backdrop-filter: blur(4px); }

    .volume-stack { display: flex; gap: 0.5rem; align-items: center; }
    .volume-stack input[type=range] { width: 110px; }

    .settings-label { font-size: 0.85rem; color: var(--text-muted); }
    .form-text { font-size: 0.8rem; }
    .section-title { font-size: 1rem; font-weight: 700; margin-top: 0.6rem; display: flex; align-items: center; gap: 0.4rem; }

    .accent-preview { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.25); }

    .theme-light { --bg: #f4f6fb; --bg-card: rgba(255,255,255,0.9); --text-main: #0f172a; --text-muted: #475569; --shadow: rgba(15, 23, 42, 0.15); }
    body.theme-light::before { opacity: 0.6; }
    body.theme-dark::before { opacity: 0.35; }

    @media (max-width: 576px) {
      .game-card { padding: 1.4rem 1.25rem; }
      .timer-value { font-size: 6.2rem; }
      .bottom-right-controls { right: 0.5rem; }
    }
  </style>
</head>
<body class="theme-dark">
  <div class="cloud-layer" id="cloudLayer"></div>

  <div class="top-right-controls">
    <button class="btn btn-outline-light btn-sm icon-btn" id="settingsButton" data-bs-toggle="modal" data-bs-target="#settingsModal" title="Settings">
      <i class="bi bi-gear-fill"></i>
    </button>
    <button class="btn btn-outline-light btn-sm icon-btn" id="themeToggle" title="Toggle theme">
      <i class="bi bi-moon-stars" id="themeIcon"></i>
    </button>
  </div>

  <div class="bottom-right-controls">
    <button class="btn btn-outline-light btn-sm icon-btn" id="backButton" title="Previous phase"><i class="bi bi-skip-backward-fill"></i></button>
    <button class="btn btn-outline-light btn-sm icon-btn" id="skipButton" title="Skip phase"><i class="bi bi-skip-forward-fill"></i></button>
    <button class="btn btn-outline-light btn-sm icon-btn" id="playPauseButton" title="Play / Pause"><i class="bi bi-play-fill" id="playPauseIcon"></i></button>
    <button class="btn btn-outline-light btn-sm icon-btn" id="muteButton" title="Mute / Unmute"><i class="bi bi-volume-up-fill" id="muteIcon"></i></button>
    <div class="volume-stack">
      <i class="bi bi-bell" title="SFX volume"></i>
      <input type="range" min="0" max="1" step="0.05" id="sfxVolume" aria-label="SFX volume">
      <i class="bi bi-music-note-beamed" title="Music volume"></i>
      <input type="range" min="0" max="1" step="0.05" id="musicVolume" aria-label="Music volume">
    </div>
  </div>

  <div class="game-wrapper">
    <div class="game-card">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="game-title">Breathing Game</div>
          <div class="game-logo">CloudyPop</div>
        </div>
        <div>
          <span class="badge-soft" id="modeBadge">Dark Mode</span>
        </div>
      </div>

      <div class="main-display">
        <div class="phase-label mb-1"><span id="phaseLabel">Ready</span></div>
        <div class="timer-value" id="timerValue">0</div>
        <div class="status-text" id="statusText">Press Play to begin a CloudyPop cycle.</div>
        <div class="cycle-counter mt-2">Cycle <span id="cycleCurrent">0</span> / <span id="cycleTotal">0</span></div>
        <div class="center-play-btn" id="centerPlayContainer">
          <button class="btn btn-primary btn-lg" id="centerPlayButton"><i class="bi bi-play-fill me-1"></i> Play</button>
        </div>
        <div id="gameOverContainer" class="mt-3 d-none text-center">
          <div class="fw-semibold">Game Over – Max cycles reached.</div>
          <button class="btn btn-outline-light btn-sm mt-2" id="restartButton"><i class="bi bi-arrow-repeat me-1"></i> Restart</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title"><i class="bi bi-sliders me-2"></i> CloudyPop Settings</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="settingsForm" class="row g-3">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <div class="section-title"><i class="bi bi-clock-history"></i> Time Control</div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="wakeLockToggle">
                  <label class="form-check-label small" for="wakeLockToggle">Keep screen awake</label>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="settings-label mb-1">Inhale (seconds)</div>
              <input type="range" class="form-range" min="1" max="12" value="4" id="inhaleMin">
              <input type="range" class="form-range" min="1" max="12" value="6" id="inhaleMax">
              <div class="form-text">Min / Max inhale time</div>
            </div>
            <div class="col-md-6">
              <div class="settings-label mb-1">Hold (seconds)</div>
              <input type="range" class="form-range" min="1" max="12" value="4" id="holdMin">
              <input type="range" class="form-range" min="1" max="12" value="6" id="holdMax">
              <div class="form-text">Min / Max hold time</div>
            </div>
            <div class="col-md-6">
              <div class="settings-label mb-1">Exhale (seconds)</div>
              <input type="range" class="form-range" min="1" max="14" value="4" id="exhaleMin">
              <input type="range" class="form-range" min="1" max="14" value="8" id="exhaleMax">
              <div class="form-text">Min / Max exhale time</div>
            </div>
            <div class="col-md-6">
              <div class="settings-label mb-1">Break (seconds)</div>
              <input type="range" class="form-range" min="0" max="12" value="3" id="breakMin">
              <input type="range" class="form-range" min="0" max="12" value="6" id="breakMax">
              <div class="form-text">Min / Max break time</div>
            </div>
            <div class="col-md-6">
              <div class="settings-label mb-1">Session start delay (seconds)</div>
              <input type="range" class="form-range" min="0" max="10" value="1" id="delayMin">
              <input type="range" class="form-range" min="0" max="10" value="3" id="delayMax">
              <div class="form-text">Pre-cycle get-ready window.</div>
            </div>
            <div class="col-md-6">
              <div class="section-title mt-1"><i class="bi bi-repeat"></i> Cycle Control</div>
              <div class="settings-label mb-1">Number of cycles</div>
              <input type="range" class="form-range" min="1" max="20" value="5" id="cycles">
              <div class="form-text">Game ends after this many cycles.</div>
            </div>
            <div class="col-12">
              <div class="section-title"><i class="bi bi-palette"></i> Page Control</div>
            </div>
            <div class="col-md-4">
              <div class="settings-label mb-1">Background color</div>
              <input type="color" class="form-control form-control-color" id="bgColor" value="#000000">
            </div>
            <div class="col-md-4">
              <div class="settings-label mb-1">Accent color</div>
              <input type="color" class="form-control form-control-color" id="accentColor" value="#6c5ce7">
            </div>
            <div class="col-md-4">
              <div class="settings-label mb-1">Accent text color</div>
              <input type="color" class="form-control form-control-color" id="textColor" value="#f8f9fa">
            </div>
            <div class="col-md-6">
              <div class="settings-label mb-1">Background image URL</div>
              <input type="url" class="form-control form-control-sm" id="bgImage" placeholder="https://example.com/bg.png">
              <div class="form-text">Leave blank to keep default clouds backdrop.</div>
            </div>
            <div class="col-md-6">
              <div class="settings-label mb-1">Upload background</div>
              <input type="file" class="form-control form-control-sm" id="bgUpload" accept="image/*">
            </div>
            <div class="col-12">
              <div class="section-title"><i class="bi bi-music-note-list"></i> Music Track</div>
              <div class="row g-2">
                <div class="col-md-6">
                  <select class="form-select form-select-sm" id="musicPreset">
                    <option value="">Choose predefined track</option>
                    <option value="https://filebrowser-bg080ow8g44scwgksgks84k0.iconic25snaps.org/files/test/media/tech1.mp3">Tech Pulse 1</option>
                    <option value="https://filebrowser-bg080ow8g44scwgksgks84k0.iconic25snaps.org/files/test/media/tech2.mp3">Tech Pulse 2</option>
                    <option value="https://filebrowser-bg080ow8g44scwgksgks84k0.iconic25snaps.org/files/test/media/tech3.mp3">Tech Pulse 3</option>
                    <option value="https://filebrowser-bg080ow8g44scwgksgks84k0.iconic25snaps.org/files/test/media/tech4.mp3">Tech Pulse 4</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <input type="url" class="form-control form-control-sm" id="musicUrl" placeholder="Or paste a music URL">
                </div>
                <div class="col-12">
                  <input type="file" class="form-control form-control-sm" id="musicUpload" accept="audio/*">
                  <div class="form-text">Upload a custom track. Supported by most modern browsers.</div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="pwaInstallPrompt">
                <label class="form-check-label" for="pwaInstallPrompt">Enable install reminders (PWA)</label>
              </div>
              <small class="text-danger" id="settingsError"></small>
            </div>
          </form>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary btn-sm" id="saveSettingsButton"><i class="bi bi-check2-circle me-1"></i> Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Service worker registration for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').catch(console.error);
      });
    }

    const defaultBackground = 'https://filebrowser-bg080ow8g44scwgksgks84k0.iconic25snaps.org/files/test/media/atl.png';
    const state = {
      isPlaying: false,
      isPaused: false,
      currentStage: null,
      currentCycle: 0,
      timeLeft: 0,
      timerId: null,
      wheelTimerId: null,
      muted: false,
      wakeLock: null,
      history: [],
      settings: {
        inhaleMin: 4,
        inhaleMax: 6,
        holdMin: 4,
        holdMax: 6,
        exhaleMin: 4,
        exhaleMax: 8,
        breakMin: 3,
        breakMax: 6,
        delayMin: 1,
        delayMax: 3,
        cycles: 5,
        bgColor: '#000000',
        accentColor: '#6c5ce7',
        textColor: '#f8f9fa',
        bgImage: defaultBackground,
        musicSource: '',
        sfxVolume: 0.6,
        musicVolume: 0.45,
        theme: 'dark',
        keepAwake: false,
        installReminder: false
      }
    };

    // Elements
    const phaseLabelEl = document.getElementById('phaseLabel');
    const timerValueEl = document.getElementById('timerValue');
    const statusTextEl = document.getElementById('statusText');
    const cycleCurrentEl = document.getElementById('cycleCurrent');
    const cycleTotalEl = document.getElementById('cycleTotal');
    const centerPlayContainerEl = document.getElementById('centerPlayContainer');
    const centerPlayButtonEl = document.getElementById('centerPlayButton');
    const gameOverContainerEl = document.getElementById('gameOverContainer');
    const restartButtonEl = document.getElementById('restartButton');
    const playPauseButtonEl = document.getElementById('playPauseButton');
    const playPauseIconEl = document.getElementById('playPauseIcon');
    const muteButtonEl = document.getElementById('muteButton');
    const muteIconEl = document.getElementById('muteIcon');
    const skipButtonEl = document.getElementById('skipButton');
    const backButtonEl = document.getElementById('backButton');
    const themeToggleEl = document.getElementById('themeToggle');
    const themeIconEl = document.getElementById('themeIcon');
    const modeBadgeEl = document.getElementById('modeBadge');
    const wakeLockToggleEl = document.getElementById('wakeLockToggle');
    const sfxVolumeEl = document.getElementById('sfxVolume');
    const musicVolumeEl = document.getElementById('musicVolume');

    const settingsErrorEl = document.getElementById('settingsError');
    const inhaleMinEl = document.getElementById('inhaleMin');
    const inhaleMaxEl = document.getElementById('inhaleMax');
    const holdMinEl = document.getElementById('holdMin');
    const holdMaxEl = document.getElementById('holdMax');
    const exhaleMinEl = document.getElementById('exhaleMin');
    const exhaleMaxEl = document.getElementById('exhaleMax');
    const breakMinEl = document.getElementById('breakMin');
    const breakMaxEl = document.getElementById('breakMax');
    const delayMinEl = document.getElementById('delayMin');
    const delayMaxEl = document.getElementById('delayMax');
    const cyclesEl = document.getElementById('cycles');
    const bgColorEl = document.getElementById('bgColor');
    const accentColorEl = document.getElementById('accentColor');
    const textColorEl = document.getElementById('textColor');
    const bgImageEl = document.getElementById('bgImage');
    const bgUploadEl = document.getElementById('bgUpload');
    const musicPresetEl = document.getElementById('musicPreset');
    const musicUrlEl = document.getElementById('musicUrl');
    const musicUploadEl = document.getElementById('musicUpload');
    const installReminderEl = document.getElementById('pwaInstallPrompt');

    const themeColorMeta = document.getElementById('themeColorMeta');

    const musicAudio = new Audio();
    musicAudio.loop = true;

    // Wake Lock
    async function requestWakeLock() {
      if (!('wakeLock' in navigator) || !state.settings.keepAwake) return;
      try {
        state.wakeLock = await navigator.wakeLock.request('screen');
        state.wakeLock.addEventListener('release', () => {
          if (state.settings.keepAwake) requestWakeLock();
        });
      } catch (err) {
        console.warn('Wake lock not available', err);
      }
    }

    function releaseWakeLock() {
      if (state.wakeLock) {
        state.wakeLock.release();
        state.wakeLock = null;
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        requestWakeLock();
      }
    });

    // Utility
    function randint(min, max) {
      min = Math.floor(min); max = Math.floor(max); if (max < min) [min, max] = [max, min];
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function setPhaseLabel(text) { phaseLabelEl.textContent = text; }
    function setTimerValue(val) { timerValueEl.textContent = val; }
    function setStatus(text) { statusTextEl.textContent = text; }

    function clearTimers() {
      if (state.timerId) { clearInterval(state.timerId); state.timerId = null; }
      if (state.wheelTimerId) { clearInterval(state.wheelTimerId); state.wheelTimerId = null; }
    }

    // Audio helpers
    function playBeep() {
      if (state.muted) return;
      try {
        if (!playBeep.audioCtx) playBeep.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = playBeep.audioCtx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.value = 880;
        gain.gain.value = 0.18 * state.settings.sfxVolume;
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.16);
      } catch (e) {}
    }

    function applyMusicSource() {
      const src = state.settings.musicSource;
      if (!src) { musicAudio.pause(); return; }
      if (musicAudio.src !== src) musicAudio.src = src;
      musicAudio.volume = state.settings.musicVolume * (state.muted ? 0 : 1);
      if (state.isPlaying && !state.isPaused) musicAudio.play().catch(()=>{});
    }

    // Settings save/load
    function saveSettingsToMemory() {
      localStorage.setItem('cloudyPopSettingsV2', JSON.stringify(state.settings));
    }

    function loadSettingsFromMemory() {
      const raw = localStorage.getItem('cloudyPopSettingsV2');
      if (!raw) return;
      try {
        Object.assign(state.settings, JSON.parse(raw));
      } catch (e) { console.warn('Unable to load saved settings'); }
    }

    function fillFormFromSettings() {
      inhaleMinEl.value = state.settings.inhaleMin;
      inhaleMaxEl.value = state.settings.inhaleMax;
      holdMinEl.value = state.settings.holdMin;
      holdMaxEl.value = state.settings.holdMax;
      exhaleMinEl.value = state.settings.exhaleMin;
      exhaleMaxEl.value = state.settings.exhaleMax;
      breakMinEl.value = state.settings.breakMin;
      breakMaxEl.value = state.settings.breakMax;
      delayMinEl.value = state.settings.delayMin;
      delayMaxEl.value = state.settings.delayMax;
      cyclesEl.value = state.settings.cycles;
      bgColorEl.value = state.settings.bgColor;
      accentColorEl.value = state.settings.accentColor;
      textColorEl.value = state.settings.textColor;
      bgImageEl.value = state.settings.bgImage !== defaultBackground ? state.settings.bgImage : '';
      musicPresetEl.value = '';
      musicUrlEl.value = '';
      wakeLockToggleEl.checked = state.settings.keepAwake;
      sfxVolumeEl.value = state.settings.sfxVolume;
      musicVolumeEl.value = state.settings.musicVolume;
      installReminderEl.checked = state.settings.installReminder;
    }

    function applyTheme() {
      const body = document.body;
      body.classList.remove('theme-dark','theme-light');
      body.classList.add(state.settings.theme === 'light' ? 'theme-light' : 'theme-dark');
      modeBadgeEl.textContent = state.settings.theme === 'light' ? 'Light Mode' : 'Dark Mode';
      themeIconEl.className = state.settings.theme === 'light' ? 'bi bi-sun-fill text-warning' : 'bi bi-moon-stars';
      document.documentElement.style.setProperty('--bg', state.settings.bgColor);
      document.documentElement.style.setProperty('--accent', state.settings.accentColor);
      document.documentElement.style.setProperty('--accent-soft', hexToRgba(state.settings.accentColor, 0.35));
      document.documentElement.style.setProperty('--text-main', state.settings.textColor);
      themeColorMeta.setAttribute('content', state.settings.bgColor);
      document.documentElement.style.setProperty('--background-image', state.settings.bgImage ? `url('${state.settings.bgImage}')` : 'none');
    }

    function hexToRgba(hex, alpha) {
      const clean = hex.replace('#','');
      const bigint = parseInt(clean,16);
      const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function loadSettingsFromForm() {
      const s = {
        inhaleMin: Number(inhaleMinEl.value) || 1,
        inhaleMax: Number(inhaleMaxEl.value) || 1,
        holdMin: Number(holdMinEl.value) || 1,
        holdMax: Number(holdMaxEl.value) || 1,
        exhaleMin: Number(exhaleMinEl.value) || 1,
        exhaleMax: Number(exhaleMaxEl.value) || 1,
        breakMin: Number(breakMinEl.value) || 0,
        breakMax: Number(breakMaxEl.value) || 0,
        delayMin: Number(delayMinEl.value) || 0,
        delayMax: Number(delayMaxEl.value) || 0,
        cycles: Number(cyclesEl.value) || 1,
        bgColor: bgColorEl.value || '#000000',
        accentColor: accentColorEl.value || '#6c5ce7',
        textColor: textColorEl.value || '#f8f9fa',
        bgImage: bgImageEl.value || state.settings.bgImage || defaultBackground,
        musicSource: state.settings.musicSource,
        sfxVolume: Number(sfxVolumeEl.value) ?? 0.6,
        musicVolume: Number(musicVolumeEl.value) ?? 0.45,
        theme: state.settings.theme,
        keepAwake: wakeLockToggleEl.checked,
        installReminder: installReminderEl.checked
      };

      const pairs = [
        ['Inhale', s.inhaleMin, s.inhaleMax],
        ['Hold', s.holdMin, s.holdMax],
        ['Exhale', s.exhaleMin, s.exhaleMax],
        ['Break', s.breakMin, s.breakMax],
        ['Delay', s.delayMin, s.delayMax]
      ];

      for (const [name, mn, mx] of pairs) {
        if (mn < 0 || mx < 0) { settingsErrorEl.textContent = name + ' cannot be negative.'; return null; }
        if (mx < mn) { settingsErrorEl.textContent = name + ' max must be ≥ min.'; return null; }
      }
      if (s.cycles < 1) { settingsErrorEl.textContent = 'Number of cycles must be at least 1.'; return null; }
      settingsErrorEl.textContent = '';
      return s;
    }

    function applySettings() {
      const newSettings = loadSettingsFromForm();
      if (!newSettings) return false;
      state.settings = { ...state.settings, ...newSettings };
      cycleTotalEl.textContent = state.settings.cycles;
      applyTheme();
      applyMusicSource();
      requestWakeLock();
      saveSettingsToMemory();
      return true;
    }

    // Cloud generator
    function createClouds() {
      const layer = document.getElementById('cloudLayer');
      const cloudCount = 14;
      layer.innerHTML = '';
      for (let i = 0; i < cloudCount; i++) {
        const cloud = document.createElement('div');
        cloud.className = 'cloud';
        const startY = Math.random() * 80;
        const endY = startY + (Math.random() * 10 - 5);
        cloud.style.setProperty('--startY', startY + 'vh');
        cloud.style.setProperty('--endY', endY + 'vh');
        const scale = 0.6 + Math.random() * 0.8;
        cloud.style.transform = 'scale(' + scale.toFixed(2) + ')';
        cloud.style.top = startY + 'vh';
        const duration = 40 + Math.random() * 50;
        const delay = Math.random() * -60;
        cloud.style.animationDuration = duration + 's';
        cloud.style.animationDelay = delay + 's';
        layer.appendChild(cloud);
      }
    }

    // Wheel spin
    function spinForRandomTime(min, max, label, doneCallback) {
      clearTimers();
      min = Math.max(0, Math.floor(min));
      max = Math.max(0, Math.floor(max));
      if (max < min) [min, max] = [max, min];
      const finalValue = randint(min, max);
      setPhaseLabel(label.toUpperCase());
      setStatus('Spinning for a random time…');
      state.wheelTimerId = setInterval(() => {
        const fake = randint(min, max);
        setTimerValue(fake + 's');
      }, 70);
      setTimeout(() => {
        clearInterval(state.wheelTimerId); state.wheelTimerId = null;
        setTimerValue(finalValue);
        setStatus('Locking in ' + finalValue + ' seconds.');
        setTimeout(() => doneCallback(finalValue), 400);
      }, 900 + Math.random() * 1000);
    }

    function startPhase(phaseName, duration, fromHistory = false) {
      clearTimers();
      state.currentStage = phaseName;
      state.timeLeft = duration;
      if (fromHistory) {
        state.history.push({ stage: phaseName, duration });
      } else {
        state.history.push({ stage: phaseName, duration });
      }
      let labelText = 'Phase';
      let statusHint = '';
      switch (phaseName) {
        case 'delay': labelText = 'Get Ready'; statusHint = 'Next cycle is about to begin.'; break;
        case 'inhale': labelText = 'Inhale'; statusHint = 'Slow deep breath in…'; break;
        case 'hold': labelText = 'Hold'; statusHint = 'Hold gently, stay relaxed.'; break;
        case 'exhale': labelText = 'Exhale'; statusHint = 'Breathe out smoothly.'; break;
        case 'break': labelText = 'Break'; statusHint = 'Rest and drift with the clouds.'; break;
      }
      setPhaseLabel(labelText.toUpperCase());
      setTimerValue(state.timeLeft);
      setStatus(statusHint);
      playBeep();
      state.timerId = setInterval(() => {
        if (!state.isPlaying || state.isPaused) return;
        state.timeLeft -= 1;
        if (state.timeLeft < 0) state.timeLeft = 0;
        setTimerValue(state.timeLeft);
        if (state.timeLeft <= 0) {
          clearInterval(state.timerId); state.timerId = null; advancePhase();
        }
      }, 1000);
    }

    function startNextCycleOrEnd() {
      const s = state.settings;
      if (state.currentCycle >= s.cycles) { endGame(); return; }
      state.currentCycle += 1;
      cycleCurrentEl.textContent = state.currentCycle;
      if (s.delayMax > 0) {
        spinForRandomTime(s.delayMin, s.delayMax, 'Get Ready', (val) => startPhase('delay', val));
      } else {
        spinForRandomTime(s.inhaleMin, s.inhaleMax, 'Inhale', (val) => startPhase('inhale', val));
      }
    }

    function advancePhase() {
      const s = state.settings;
      const stage = state.currentStage;
      if (!state.isPlaying) return;
      if (stage === 'delay') {
        spinForRandomTime(s.inhaleMin, s.inhaleMax, 'Inhale', (val) => startPhase('inhale', val));
      } else if (stage === 'inhale') {
        spinForRandomTime(s.holdMin, s.holdMax, 'Hold', (val) => startPhase('hold', val));
      } else if (stage === 'hold') {
        spinForRandomTime(s.exhaleMin, s.exhaleMax, 'Exhale', (val) => startPhase('exhale', val));
      } else if (stage === 'exhale') {
        if (s.breakMax > 0) {
          spinForRandomTime(s.breakMin, s.breakMax, 'Break', (val) => {
            if (val === 0) { startNextCycleOrEnd(); }
            else { startPhase('break', val); }
          });
        } else { startNextCycleOrEnd(); }
      } else if (stage === 'break') {
        startNextCycleOrEnd();
      } else { startNextCycleOrEnd(); }
    }

    function startGame() {
      if (!applySettings()) return;
      clearTimers();
      state.history = [];
      state.isPlaying = true;
      state.isPaused = false;
      state.currentCycle = 0;
      state.currentStage = null;
      gameOverContainerEl.classList.add('d-none');
      centerPlayContainerEl.classList.add('d-none');
      cycleTotalEl.textContent = state.settings.cycles;
      cycleCurrentEl.textContent = 0;
      setStatus('Spinning up your first CloudyPop cycle…');
      setTimerValue('—');
      setPhaseLabel('READY');
      updatePlayPauseButton();
      applyMusicSource();
      musicAudio.play().catch(()=>{});
      startNextCycleOrEnd();
      if (state.settings.keepAwake) requestWakeLock(); else releaseWakeLock();
    }

    function pauseGame() {
      if (!state.isPlaying) return;
      state.isPaused = true;
      musicAudio.pause();
      setStatus('Paused. Press Play to resume.');
      updatePlayPauseButton();
    }

    function resumeGame() {
      if (!state.isPlaying) return;
      state.isPaused = false;
      setStatus('Back in the clouds.');
      updatePlayPauseButton();
      applyMusicSource();
    }

    function endGame() {
      clearTimers();
      state.isPlaying = false;
      state.isPaused = false;
      setPhaseLabel('GAME OVER');
      setStatus('You finished all your CloudyPop cycles.');
      setTimerValue('0');
      gameOverContainerEl.classList.remove('d-none');
      centerPlayContainerEl.classList.remove('d-none');
      musicAudio.pause();
      updatePlayPauseButton();
    }

    function updatePlayPauseButton() {
      if (!state.isPlaying || state.isPaused) {
        playPauseIconEl.className = 'bi bi-play-fill';
      } else {
        playPauseIconEl.className = 'bi bi-pause-fill';
      }
    }

    // Transport controls
    centerPlayButtonEl.addEventListener('click', startGame);
    restartButtonEl.addEventListener('click', startGame);
    playPauseButtonEl.addEventListener('click', () => {
      if (!state.isPlaying) { startGame(); }
      else if (state.isPaused) { resumeGame(); }
      else { pauseGame(); }
    });

    skipButtonEl.addEventListener('click', () => {
      if (!state.isPlaying) return;
      if (state.currentStage === 'break' && state.currentCycle >= state.settings.cycles) {
        startGame();
      } else {
        advancePhase();
      }
    });

    backButtonEl.addEventListener('click', () => {
      if (!state.isPlaying || state.history.length < 2) return;
      state.history.pop();
      const prev = state.history.pop();
      if (!prev) return;
      startPhase(prev.stage, prev.duration, true);
    });

    muteButtonEl.addEventListener('click', () => {
      state.muted = !state.muted;
      muteIconEl.className = state.muted ? 'bi bi-volume-mute-fill' : 'bi bi-volume-up-fill';
      musicAudio.muted = state.muted;
      saveSettingsToMemory();
    });

    sfxVolumeEl.addEventListener('input', () => {
      state.settings.sfxVolume = Number(sfxVolumeEl.value);
      saveSettingsToMemory();
    });

    musicVolumeEl.addEventListener('input', () => {
      state.settings.musicVolume = Number(musicVolumeEl.value);
      musicAudio.volume = state.settings.musicVolume * (state.muted ? 0 : 1);
      saveSettingsToMemory();
    });

    themeToggleEl.addEventListener('click', () => {
      state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
      applyTheme();
      saveSettingsToMemory();
    });

    // Music selection handlers
    musicPresetEl.addEventListener('change', () => {
      if (musicPresetEl.value) {
        state.settings.musicSource = musicPresetEl.value;
        musicUrlEl.value = '';
        applyMusicSource();
      }
    });

    musicUrlEl.addEventListener('change', () => {
      if (musicUrlEl.value) {
        state.settings.musicSource = musicUrlEl.value;
        musicPresetEl.value = '';
        applyMusicSource();
      }
    });

    musicUploadEl.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      state.settings.musicSource = url;
      musicPresetEl.value = '';
      musicUrlEl.value = '';
      applyMusicSource();
    });

    bgUploadEl.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      state.settings.bgImage = url;
      applyTheme();
    });

    saveSettingsButtonEl.addEventListener('click', () => {
      if (applySettings()) {
        saveSettingsToMemory();
        const modalEl = document.getElementById('settingsModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
      }
    });

    // Init
    window.addEventListener('DOMContentLoaded', () => {
      loadSettingsFromMemory();
      fillFormFromSettings();
      applySettings();
      createClouds();
      setPhaseLabel('READY');
      setTimerValue('0');
      setStatus('Press Play to begin a CloudyPop cycle.');
    });
  </script>
</body>
</html>
